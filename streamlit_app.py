import streamlit as st
import pandas as pd
from datetime import datetime

# È°µÈù¢Âü∫Á°ÄËÆæÁΩÆ
st.set_page_config(page_title="ËΩ¶Êï∞Âê®Êï∞Ëá™Âä®Ê±áÊÄª", page_icon="üöõ")

def process_data(df):
    # 1. ÂØπÂ∫î‰Ω†ÂõæÁâá‰∏≠ÁöÑË°®Â§¥
        mapping = {
                'ËøáÁ£ÖÁ±ªÂûã': 'ËøáÁ£ÖÁ±ªÂûã',  # NÂàó
                        'Êî∂Ë¥ßÂçï‰Ωç': 'Êî∂Ë¥ßÂçï‰Ωç',  # KÂàó
                                'Ë¥ßÁâ©ÂêçÁß∞': 'Ë¥ßÁâ©ÂêçÁß∞',  # EÂàó
                                        'ÂûãÂè∑ËßÑÊ†º': 'ÂûãÂè∑ËßÑÊ†º',  # LÂàó
                                                'ÂáÄÈáç': 'ÂáÄÈáç',          # HÂàó
                                                        'ÈáëÈ¢ù': 'ÈáëÈ¢ù'           # JÂàó
                                                            }
                                                                
                                                                    # Ê∏ÖÊ¥óÔºöÂéªÈô§Á©∫Ê†ºÔºåÁ°Æ‰øùÂàóÂêçÂåπÈÖç
                                                                        df.columns = [str(c).strip() for c in df.columns]
                                                                            
                                                                                # 2. Ê†∏ÂøÉÂàÜÁ±ªÈÄªËæë
                                                                                    def check_cat(x):
                                                                                            val = str(x).strip()
                                                                                                    if 'Èõ∂ÂîÆÔºàÁé∞ÈáëÔºâ' in val: return 'Áé∞Èáë'
                                                                                                            if 'Èõ∂ÂîÆÔºàÂæÆ‰ø°Ôºâ' in val: return 'ÂæÆ‰ø°'
                                                                                                                    if 'Á≠æÂçï' in val: return 'Á≠æÂçï'
                                                                                                                            return 'ÂÖ∂‰ªñ'

                                                                                                                                df['ÂàÜÁ±ª'] = df['ËøáÁ£ÖÁ±ªÂûã'].apply(check_cat)
                                                                                                                                    df['ËΩ¶Êï∞'] = 1  # ÊØè‰∏ÄË°å‰∏∫‰∏ÄËΩ¶
                                                                                                                                        
                                                                                                                                            # Â°´ÂÖÖÁ©∫ÂÄºÔºåÈÅøÂÖçÊòæÁ§∫ "nan"
                                                                                                                                                df = df.fillna('')
                                                                                                                                                    # Á°Æ‰øùÊï∞Â≠óÂàóÂèØ‰ª•ËÆ°ÁÆó
                                                                                                                                                        df['ÂáÄÈáç'] = pd.to_numeric(df['ÂáÄÈáç'], errors='coerce').fillna(0)
                                                                                                                                                            df['ÈáëÈ¢ù'] = pd.to_numeric(df['ÈáëÈ¢ù'], errors='coerce').fillna(0)

                                                                                                                                                                # 3. ÂºÄÂßãÊãºË£ÖÊñáÊú¨
                                                                                                                                                                    now = datetime.now().strftime("%Y-%m-%d %H:%M")
                                                                                                                                                                        
                                                                                                                                                                            # ÊÄªÊ±áÊÄªÔºàÊéíÈô§‚ÄúÂÖ∂‰ªñ‚ÄùÁ±ªÂûãÔºâ
                                                                                                                                                                                main_data = df[df['ÂàÜÁ±ª'] != 'ÂÖ∂‰ªñ']
                                                                                                                                                                                    total_cars = len(main_data)
                                                                                                                                                                                        total_tons = main_data['ÂáÄÈáç'].sum()
                                                                                                                                                                                            total_money = main_data['ÈáëÈ¢ù'].sum()

                                                                                                                                                                                                res = []
                                                                                                                                                                                                    res.append(f"{now}")
                                                                                                                                                                                                        res.append(f"‰ªäÊó•ËΩ¶Êï∞ {total_cars} ‰ªäÊó•Âê®Êï∞ {total_tons:.2f} ÈáëÈ¢ù {total_money:.2f}")
                                                                                                                                                                                                            res.append("-" * 25)

                                                                                                                                                                                                                # Êåâ Áé∞Èáë -> ÂæÆ‰ø° -> Á≠æÂçï È°∫Â∫èÊéíÂàó
                                                                                                                                                                                                                    for cat in ['Áé∞Èáë', 'ÂæÆ‰ø°', 'Á≠æÂçï']:
                                                                                                                                                                                                                            sub = df[df['ÂàÜÁ±ª'] == cat]
                                                                                                                                                                                                                                    if sub.empty: continue
                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                    s_cars = len(sub)
                                                                                                                                                                                                                                                            s_tons = sub['ÂáÄÈáç'].sum()
                                                                                                                                                                                                                                                                    s_money = sub['ÈáëÈ¢ù'].sum()
                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                    # Á≠æÂçïÊ†áÈ¢òË°å‰∏çÂ∏¶ÈáëÈ¢ù
                                                                                                                                                                                                                                                                                            if cat == 'Á≠æÂçï':
                                                                                                                                                                                                                                                                                                        res.append(f"\n{cat}: ËΩ¶Êï∞ {s_cars} Âê®Êï∞ {s_tons:.2f}")
                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                            res.append(f"\n{cat}: ËΩ¶Êï∞ {s_cars} Âê®Êï∞ {s_tons:.2f} ÈáëÈ¢ù {s_money:.2f}")
                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                            # ÊòéÁªÜË°å
                                                                                                                                                                                                                                                                                                                                                    for _, row in sub.iterrows():
                                                                                                                                                                                                                                                                                                                                                                if str(row['Êî∂Ë¥ßÂçï‰Ωç']).strip():
                                                                                                                                                                                                                                                                                                                                                                                res.append(f"{row['Êî∂Ë¥ßÂçï‰Ωç']}")
                                                                                                                                                                                                                                                                                                                                                                                            # Ê†ºÂºèÔºöË¥ßÁâ©ÂêçÁß∞ ÂûãÂè∑ËßÑÊ†º ËΩ¶Êï∞(1) Âê®Êï∞ ÈáëÈ¢ù
                                                                                                                                                                                                                                                                                                                                                                                                        res.append(f"{row['Ë¥ßÁâ©ÂêçÁß∞']} {row['ÂûãÂè∑ËßÑÊ†º']} 1 {row['ÂáÄÈáç']:.2f} {row['ÈáëÈ¢ù']:.2f}")

                                                                                                                                                                                                                                                                                                                                                                                                            return "\n".join(res)

                                                                                                                                                                                                                                                                                                                                                                                                            # --- ÁΩëÈ°µÁïåÈù¢ ---
                                                                                                                                                                                                                                                                                                                                                                                                            st.title("üöõ Ëá™Âä®Ê±áÊÄªÊä•Êï∞Âä©Êâã")

                                                                                                                                                                                                                                                                                                                                                                                                            uploaded_file = st.file_uploader("ÁÇπÂáªÊ≠§Â§Ñ‰∏ä‰º† Excel Êñá‰ª∂", type=["xlsx", "xls"])

                                                                                                                                                                                                                                                                                                                                                                                                            if uploaded_file:
                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                        df = pd.read_excel(uploaded_file)
                                                                                                                                                                                                                                                                                                                                                                                                                                # Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ËøáÁ£ÖÁ±ªÂûã
                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'ËøáÁ£ÖÁ±ªÂûã' not in [str(c).strip() for c in df.columns]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.error("‰∏ä‰º†Â§±Ë¥•ÔºöExcel ‰∏≠Êâæ‰∏çÂà∞„ÄêËøáÁ£ÖÁ±ªÂûã„ÄëÂàóÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂„ÄÇ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_text = process_data(df)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.success("Ê±áÊÄªÁîüÊàêÊàêÂäüÔºÅ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Êñπ‰æøÊâãÊú∫ÁÇπÂáª‰∏ÄÈîÆÂ§çÂà∂
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.text_area("ÈïøÊåâ‰∏ãÊñπÊñáÂ≠óÂÖ®ÈÄâÂ§çÂà∂Ôºö", value=final_text, height=450)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.button("Ê∏ÖÈô§Êï∞ÊçÆÈáçÊñ∞‰∏ä‰º†")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.error(f"Â§ÑÁêÜÂá∫ÈîôÔºö{e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                    